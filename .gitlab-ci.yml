image: docker:23.0.4

services:
  - docker:23.0.4-dind

stages:
  - build

before_script:
  - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  - apk update && apk add bash

build:
  stage: build
  parallel:
    matrix:
      - IMAGE_NAME: bind
      - IMAGE_NAME: dovecot
      - IMAGE_NAME: elastic-aggregate
      - IMAGE_NAME: ffmpeg
      - IMAGE_NAME: fritzbox2elastic
      - IMAGE_NAME: g10k
      - IMAGE_NAME: hugo-obsidian
      - IMAGE_NAME: nagflux
      - IMAGE_NAME: ocrmypdf-inotify
      - IMAGE_NAME: samba
  script: "./build-image.sh ${IMAGE_NAME}"
  rules:
    - changes:
        - .gitlab-ci.yml
        - build-image.sh
        - images/${IMAGE_NAME}/**/*

build-generic-web:
  stage: build
  parallel:
    matrix:
      - PHP_VERSION:
          - "7.4"
          - "8.1"
  script: "./build-image.sh generic-web php${PHP_VERSION} --build-arg PHP_VERSION=${PHP_VERSION}"
  rules:
    - changes:
        - .gitlab-ci.yml
        - build-image.sh
        - images/generic-web/**/*