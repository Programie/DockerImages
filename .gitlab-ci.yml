# This is a GitLab CI configuration to build the project as a docker image
# The file is generic enough to be dropped in a project containing a working Dockerfile
# Author: Florent CHAUVEAU <florent.chauveau@gmail.com>
# Mentioned here: https://blog.callr.tech/building-docker-images-with-gitlab-ci-best-practices/

image: jdrouet/docker-with-buildx:stable

stages:
  - build

# Use this if your GitLab runner does not use socket binding
services:
  - docker:dind

before_script:
  # docker login asks for the password to be passed through stdin for security
  # we use $CI_JOB_TOKEN here which is a special token provided by GitLab
  - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  - apk update && apk add bash

build:
  stage: build
  parallel:
    matrix:
      - JOB_NAME:
          - bind
          - dovecot
          - elastic-aggregate
          - ffmpeg
          - fritzbox2elastic
          - g10k
          - hugo-obsidian
          - nagflux
          - ocrmypdf-inotify
          - samba
  script: "./build-image.sh ${JOB_NAME}"
  only:
    changes:
      - .gitlab-ci.yml
      - build-image.sh
      - ${JOB_NAME}/**/*

build-generic-web:
  stage: build
  parallel:
    matrix:
      - PHP_VERSION:
          - "7.4"
          - "8.1"
  script: "./build-image.sh generic-web php${PHP_VERSION} amd64 --build-arg PHP_VERSION=${PHP_VERSION}"
  only:
    changes:
      - .gitlab-ci.yml
      - build-image.sh
      - generic-web/**/*