image: docker:23.0.4

services:
  - docker:23.0.4-dind

stages:
  - build

before_script:
  - echo -n $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  - apk update && apk add bash

build:
  stage: build
  parallel:
    matrix:
      - IMAGE_NAME:
          - bind
          - dovecot
          - elastic-aggregate
          - ffmpeg
          - fritzbox2elastic
          - g10k
          - hugo-obsidian
          - nagflux
          - ocrmypdf-inotify
          - samba
  script: "./build-image.sh ${IMAGE_NAME}"
  rules:
    - changes:
        - .gitlab-ci.yml
        - build-image.sh
        - images/${IMAGE_NAME}/**/*

build-generic-web:
  stage: build
  parallel:
    matrix:
      - PHP_VERSION:
          - "7.4"
          - "8.1"
  script: "./build-image.sh generic-web php${PHP_VERSION} --build-arg PHP_VERSION=${PHP_VERSION}"
  rules:
    - changes:
        - .gitlab-ci.yml
        - build-image.sh
        - images/generic-web/**/*